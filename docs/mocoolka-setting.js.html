<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>mocoolka-setting.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-mocoolka-setting.html">mocoolka-setting</a><ul class='methods'><li data-type='method'><a href="module-mocoolka-setting.html#~applyModuleSetting">applyModuleSetting</a></li><li data-type='method'><a href="module-mocoolka-setting.html#~getAppSetting">getAppSetting</a></li><li data-type='method'><a href="module-mocoolka-setting.html#~getModuleSetting">getModuleSetting</a></li><li data-type='method'><a href="module-mocoolka-setting.html#~init">init</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">mocoolka-setting.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// © Copyright Mocoolka Corporation 2015,2017.
// Node module: mocoolka-tools
// LICENSE: MIT

/** @module mocoolka-setting */
let { fileTools, globalTools, objectTools, errorTools, typeTools }
= require('../../mocoolka-tools/src/index.js');

/**
 * This callback is displayed as part of the getModuleSetting member.
 * @callback applyModuleSetting~Callback
 * @param {Object} error - Determines whether the function have error.null if no error;
 * @param {Object} data - module setting
 */

/**
 * apply application setting to module setting.it will try read app.mk-setting.json in root directory
 * merge with module setting and application setting
 * @param {Object} msg -message
 * @property {string} msg.moduleName - module name in app.mk-setting.json
 * @property {Object} [msg.moduleDefaultSetting] - default setting
 * @param {applyModuleSetting~Callback} callback
 */
const applyModuleSetting = (msg, callback) => {
  try {
    if (!typeTools.isFunction(callback))
      return;
    errorTools.validateJsonSchema({ schema: settingManager.schemas.applyModuleSetting, data: msg });

    const moduleName = msg.moduleName;
    const moduleDefaultSetting = msg.moduleDefaultSetting;
    let moduleSetting = objectTools.mergeAll(false, true, moduleDefaultSetting, _getAppSetting(moduleName));
    globalTools.setGlobalItem(moduleName, moduleSetting);
    if (callback)
      callback(null, moduleSetting);
  }
  catch (ex) {
    callback(ex);
  }

};

/**
 * This callback is displayed as part of the getModuleSetting member.
 * @callback getModuleSettingCallback
 * @param {Object} error - Determines whether the function have error.null if no error;
 * @param {Object} data - module setting
 */

/**
 * get module setting
 * @param {Object} msg -message
 * @property {string} msg.moduleName - module name in app.mk-setting.json
 * @property {string} [msg.itemName] - property name in module setting  .if value is null return module setting
 * @param {getModuleSettingCallback} callback - return module setting
 */
const getModuleSetting = (msg, callback) => {
  try {
    if (!typeTools.isFunction(callback))
      return;

    errorTools.validateJsonSchema({ schema: settingManager.schemas.getModuleSetting, data: msg });

    let result;
    const moduleName = msg.moduleName;
    const itemName = msg.itemName;
    let moduleSetting = globalTools.getGlobalItem(moduleName);
    if (moduleSetting) {
      if (itemName) {
        if (moduleSetting[itemName]) {
          result = moduleSetting[itemName];
        } else {
          result = null;
        }
      }
    }

    result = moduleSetting;
    callback(null, result);
  }
  catch (ex) {
    callback(ex);
  }
};

/**
 * This callback is displayed as part of the init member.
 * @callback initCallback
 * @param {Object} error - Determines whether the function have error.null if no error;
 */

/**
 * init module
 * @param {Object} options
 * @property {string} options.rootPath - root path contain 'app.mk-setting.json'
 * @param {initCallback} callback
 */
function init(options, callback) {
  try {
    options = settingManager.initOptions || options;
    errorTools.validateCallback(callback);
    errorTools.validateJsonSchema({
      schema: settingManager.schemas.init,
      data: options,
    });

    const rootPath = options.rootPath;

    errorTools.directoryNotExist(rootPath);

    settingManager.setting.filePath = rootPath;
    let appSettingPath = fileTools.path(rootPath, settingManager.setting.fileName);
    if (fileTools.fileExist(appSettingPath)) {
      settingManager.appSetting = fileTools.openFile(appSettingPath);

    } else {
      settingManager.appSetting = {};
    }

    applyModuleSetting({
      moduleName: settingManager.moduleName,
      moduleDefaultSetting: settingManager.setting,
    }, (errors, data)=> {
      if (errors)
        callback(errors);
      settingManager.setting = data;
      callback(null);

    });
  }
  catch (ex) {
    if (callback)
       callback(ex);
  }

};

/**
 * This callback is displayed as part of the getAppSetting manager.
 * @callback getAppSettingCallback
 * @param {Object} error - Determines whether the function have error.null if no error;
 * @param {Object} data - application setting in 'app.mk-setting.json'
 */

/**
 * get application setting
 * @param {getAppSettingCallback} callback - The callback that return application setting
 */
const getAppSetting = (callback) => {
  callback(null, _getAppSetting());
};

/**
 * get application
 * @private
 * @param {string} [nodeName] node name in 'app.mk-setting.json'.if null return application setting
 * @return {Object} module setting
 */
const _getAppSetting = (moduleName) => {
  if (moduleName) {
    if (settingManager.appSetting &amp;&amp; settingManager.appSetting[moduleName]) {
      return settingManager.appSetting[moduleName];
    } else
      return null;
  }

  return settingManager.appSetting;
};

const settingManager = {
  moduleName: 'mocoolka-setting',
  setting: {
    fileName: 'app.mk-setting.json',
    filePath: null,
  }, actions: {
    applyModuleSetting,
    getModuleSetting,
    getAppSetting,
  },
  schemas: {
      applyModuleSetting: {
        properties: {
          moduleName: {
            type: 'string',
          },
          moduleDefaultSetting: {
            type: 'object',
            default: {},
          },
        },
        required: ['moduleName', 'moduleDefaultSetting'],
      },
      getModuleSetting: {
        properties: {
          moduleName: {
            type: 'string',
          },
          itemName: {
            type: 'string',
          },
        },
        required: ['moduleName'],
      },
      init: {
        properties: {
          rootPath: {
            type: 'string',
          },
        },
        required: ['rootPath'],
      },

    },
  appSetting: null,
  init,
};

module.exports = settingManager;

</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Tue Apr 25 2017 23:26:03 GMT+0800 (中国标准时间) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
